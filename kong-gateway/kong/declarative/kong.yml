# kong/declarative/kong.yml
_format_version: "3.0"
_transform: true

services:
  - name: auth
    url: http://auth-service:3100
    tags:
      - auth
      - public
    routes:
      - name: auth-login
        paths:
          - /auth
        methods:
          - GET
          - POST
          - OPTIONS
        strip_path: false
        preserve_host: false
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - OPTIONS
          headers:
            - Accept
            - Content-Type
          credentials: true
          max_age: 3600

  - name: msorders
    url: http://msorders:3000
    tags:
      - orders
      - graphql
    routes:
      - name: msorders-graphql
        paths:
          - /orders
        methods:
          - GET
          - POST
          - OPTIONS
        strip_path: true
        preserve_host: false
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - OPTIONS
          headers:
            - Accept
            - Content-Type
            - Authorization
          credentials: true
          max_age: 3600
      - name: jwt
        config:
          uri_param_names:
            - jwt
          cookie_names: []
          header_names:
            - Authorization
          claims_to_verify:
            - exp
          run_on_preflight: false
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000
          policy: local

  - name: msrouting
    url: http://msrouting:3004
    tags:
      - routing
      - graphql
    routes:
      - name: msrouting-graphql
        paths:
          - /routing
        methods:
          - GET
          - POST
          - OPTIONS
        strip_path: true
        preserve_host: false
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - OPTIONS
          headers:
            - Accept
            - Content-Type
            - Authorization
          credentials: true
          max_age: 3600
      - name: jwt
        config:
          uri_param_names:
            - jwt
          cookie_names: []
          header_names:
            - Authorization
          claims_to_verify:
            - exp
          run_on_preflight: false
      - name: rate-limiting
        config:
          minute: 200
          hour: 2000
          policy: local

  - name: mscustomers
    url: http://mscustomers:3000
    tags:
      - customers
      - graphql
    routes:
      - name: mscustomers-graphql
        paths:
          - /customers
        methods:
          - GET
          - POST
          - OPTIONS
        strip_path: true
        preserve_host: false
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - OPTIONS
          headers:
            - Accept
            - Content-Type
            - Authorization
          credentials: true
          max_age: 3600
      - name: jwt
        config:
          uri_param_names:
            - jwt
          cookie_names: []
          header_names:
            - Authorization
          claims_to_verify:
            - exp
          run_on_preflight: false
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000
          policy: local

  - name: msnotifications
    url: http://msnotifications:3000
    tags:
      - notifications
      - graphql
    routes:
      - name: msnotifications-graphql
        paths:
          - /notifications
        methods:
          - GET
          - POST
          - OPTIONS
        strip_path: true
        preserve_host: false
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - OPTIONS
          headers:
            - Accept
            - Content-Type
            - Authorization
          credentials: true
          max_age: 3600
      - name: jwt
        config:
          uri_param_names:
            - jwt
          cookie_names: []
          header_names:
            - Authorization
          claims_to_verify:
            - exp
          run_on_preflight: false
      - name: rate-limiting
        config:
          minute: 200
          hour: 2000
          policy: local

  - name: msdelivery
    url: http://msdelivery:3000
    tags:
      - delivery
      - rest
      - graphql
    routes:
      - name: msdelivery-api
        paths:
          - /delivery
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
        strip_path: true
        preserve_host: false
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - PATCH
            - OPTIONS
          headers:
            - Accept
            - Content-Type
            - Authorization
          credentials: true
          max_age: 3600
      - name: jwt
        config:
          uri_param_names:
            - jwt
          cookie_names: []
          header_names:
            - Authorization
          claims_to_verify:
            - exp
          run_on_preflight: false
      - name: rate-limiting
        config:
          minute: 150
          hour: 1500
          policy: local

  - name: mstracking
    url: http://mstracking:3005
    tags:
      - tracking
      - graphql
    routes:
      - name: mstracking-graphql
        paths:
          - /tracking
        methods:
          - GET
          - POST
          - OPTIONS
        strip_path: true
        preserve_host: false
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - OPTIONS
          headers:
            - Accept
            - Content-Type
            - Authorization
          credentials: true
          max_age: 3600
      - name: jwt
        config:
          uri_param_names:
            - jwt
          cookie_names: []
          header_names:
            - Authorization
          claims_to_verify:
            - exp
          run_on_preflight: false
      - name: rate-limiting
        config:
          minute: 150
          hour: 1500
          policy: local

consumers:
  - username: web-app
    tags:
      - frontend
      - web
    jwt_secrets:
      - key: web-app-issuer
        algorithm: HS256
        secret: __KONG_JWT_SECRET_WEB_APP__
  - username: admin-panel
    tags:
      - admin
      - internal
    jwt_secrets:
      - key: admin-panel-issuer
        algorithm: HS256
        secret: __KONG_JWT_SECRET_ADMIN_PANEL__