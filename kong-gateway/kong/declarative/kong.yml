# kong/declarative/kong.yml
_format_version: "3.0"
_transform: true

services:
  - name: msorders
    url: http://msorders:3000
    tags:
      - orders
      - graphql
    routes:
      - name: msorders-graphql
        paths:
          - /orders/graphql
        methods:
          - GET
          - POST
          - OPTIONS
        strip_path: true
        preserve_host: false
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - OPTIONS
          headers:
            - Accept
            - Content-Type
            - Authorization
          credentials: true
          max_age: 3600
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000
          policy: local

  - name: mscustomers
    url: http://mscustomers:3000
    tags:
      - customers
      - graphql
    routes:
      - name: mscustomers-graphql
        paths:
          - /customers/graphql
        methods:
          - GET
          - POST
          - OPTIONS
        strip_path: true
        preserve_host: false
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - OPTIONS
          headers:
            - Accept
            - Content-Type
            - Authorization
          credentials: true
          max_age: 3600
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000
          policy: local

  - name: msnotifications
    url: http://msnotifications:3000
    tags:
      - notifications
      - graphql
    routes:
      - name: msnotifications-graphql
        paths:
          - /notifications/graphql
        methods:
          - GET
          - POST
          - OPTIONS
        strip_path: true
        preserve_host: false
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - OPTIONS
          headers:
            - Accept
            - Content-Type
            - Authorization
          credentials: true
          max_age: 3600
      - name: rate-limiting
        config:
          minute: 200
          hour: 2000
          policy: local

  - name: msrouting
    url: http://msrouting:3004
    tags:
      - routing
      - graphql
    routes:
      - name: msrouting-graphql
        paths:
          - /routing/graphql
        methods:
          - GET
          - POST
          - OPTIONS
        strip_path: true
        preserve_host: false
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - OPTIONS
          headers:
            - Accept
            - Content-Type
            - Authorization
          credentials: true
          max_age: 3600
      - name: rate-limiting
        config:
          minute: 150
          hour: 1500
          policy: local

plugins:
  - name: jwt
    config:
      uri_param_names:
        - jwt
      cookie_names: []
      header_names:
        - Authorization
      claims_to_verify:
        - exp
      run_on_preflight: false

consumers:
  - username: web-app
    tags:
      - frontend
      - web
    jwt_secrets:
      - key: web-app-issuer
        algorithm: HS256
        secret: condense-aerospace-percolate-prelaunch-skylight-surely
  - username: admin-panel
    tags:
      - admin
      - internal
    jwt_secrets:
      - key: admin-panel-issuer
        algorithm: HS256
        secret: cosponsor-sculptor-cubicle-usher-mutable-dispersal